<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCK Forskningsöversikt</title>
    <style>
        /* Globala stilar (Återställd till den snygga versionen) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #004d99;
        }

        /* Filter- och Form-containers */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        #filters, #addProjectForm {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #555;
        }

        input[type="text"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }

        textarea {
            grid-column: 1 / -1;
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        /* Knapp för att lägga till/spara projekt */
        #addProjectForm button {
            background-color: #007bff;
            color: white;
        }

        #addProjectForm button:hover {
            background-color: #0056b3;
        }

        /* Sökknapp */
        #searchButton {
            background-color: #28a745;
            color: white;
            grid-column: auto;
        }

        #searchButton:hover {
            background-color: #1e7e34;
        }

        /* Resultatlistan */
        #results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding-top: 20px;
        }

        .project-card {
            background: #f9f9f9;
            padding: 20px;
            border: 1px solid #ddd;
            border-left: 5px solid #004d99;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.1);
        }

        .project-card h3 {
            margin-top: 0;
            color: #004d99;
            border-bottom: 1px dotted #ccc;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .project-card p {
            margin-bottom: 5px;
        }
        
        /* Knappar i kortet - Återställd enklare placering */
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end; /* Flyttar knapparna till höger */
        }
        
        .edit-btn {
            background-color: #ffc107; /* Gul (Redigera) */
            color: #333;
        }
        .edit-btn:hover {
            background-color: #e0a800;
        }
        
        .delete-btn {
            background-color: #dc3545; /* Röd (Ta bort) */
            color: white;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        /* Flexibel layout för formulärknappen */
        #addProjectForm > div {
            display: flex;
            align-items: flex-end;
        }
        #addProjectForm button {
            width: 100%;
        }
    </style>
</head>
<body>

    <h1>NCK Forskningsöversikt</h1>

    <div class="container">
        <h2>Lägg till / Redigera Projekt</h2>
        <form id="addProjectForm" onsubmit="event.preventDefault(); addProject();">
            <div>
                <label for="titel">Titel:</label>
                <input type="text" id="titel" required>
            </div>
            <div>
                <label for="status">Status:</label>
                <select id="status" required>
                    <option value="Planerad">Planerad</option>
                    <option value="Pågående">Pågående</option>
                    <option value="Avslutad">Avslutad</option>
                </select>
            </div>
            <div>
                <label for="datum">Datumintervall (YYYY-YYYY eller YYYY-):</label>
                <input type="text" id="datum" placeholder="t.ex. 2024-2025" required>
            </div>
            <div>
                <label for="deltagare">Deltagare (kommaseparerat):</label>
                <input type="text" id="deltagare" placeholder="t.ex. Anna, Pelle">
            </div>
            <div style="grid-column: 1 / -1;">
                <label for="beskrivning">Beskrivning:</label>
                <textarea id="beskrivning"></textarea>
            </div>
            <div>
                <button type="submit">Lägg till projekt</button>
            </div>
        </form>
    </div>


    <div class="container">
        <h2>Filter & Sök</h2>
        <div id="filters">
            <div>
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" onchange="applyFilters()">
                    <option value="">Alla statusar</option>
                    <option value="Planerad">Planerad</option>
                    <option value="Pågående">Pågående</option>
                    <option value="Avslutad">Avslutad</option>
                </select>
            </div>
            <div>
                <label for="yearFilter">År:</label>
                <select id="yearFilter" onchange="applyFilters()">
                    <option value="">Alla år</option>
                    </select>
            </div>
            <div>
                <label for="searchQuery">Fritextsökning:</label>
                <input type="text" id="searchQuery" placeholder="Titel, deltagare, beskrivning...">
            </div>
            <div>
                <button id="searchButton" onclick="applyFilters()">Sök</button>
            </div>
        </div>
    </div>


    <div class="container">
        <h2>Projektresultat</h2>
        <div id="results">
            </div>
    </div>

    <script>
        // =========================================================
        // 1. Inställningar och Variabler
        // =========================================================

        let editingProjectId = null;
        let projects = []; // Vi startar med tom data, fylls på via API
        
        // !!! VIKTIGT: DENNA MÅSTE UPPDATERAS NÄR DU HAR DITT GOOGLE APP SCRIPT URL !!!
        const API_URL = 'DIN_PUBLISHERADE_GOOGLE_APP_SCRIPT_URL_HÄR';


        // =========================================================
        // 2. Datahantering (API-funktioner)
        // =========================================================

        // Laddar data från Google Sheet (API)
        async function loadProjects() {
            try {
                const response = await fetch(`${API_URL}?action=read`);
                if (!response.ok) throw new Error('Kunde inte läsa data från datakällan.');
                
                const data = await response.json();
                
                // Kontrollera om data är en array, annars tom
                projects = Array.isArray(data) ? data : [];
                
                populateYearFilter(); // Uppdatera år-filter
                applyFilters();       // Visa resultaten
            } catch (error) {
                console.error("Fel vid laddning av projekt:", error);
                document.getElementById('results').innerHTML = '<p>Kunde inte ladda data. Kontrollera API-anslutningen och Google Sheet URL:en.</p>';
            }
        }
        
        // Skickar data till API:et för att lägga till eller uppdatera
        async function saveProjectToSheet(projectData, action) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    // Skicka data som URL-kodad sträng
                    body: new URLSearchParams({ 
                        action: action, 
                        data: JSON.stringify(projectData) 
                    }).toString()
                });

                if (!response.ok) throw new Error('API-anropet misslyckades.');
                
                // Ladda om alla projekt från Sheet efter en lyckad sparoperation
                await loadProjects(); 
                
            } catch (error) {
                console.error(`Fel vid ${action} av projekt:`, error);
                alert(`Kunde inte spara/uppdatera. Kontrollera API-anslutningen. Fel: ${error.message}`);
            }
        }
        
        // Skickar en begäran till API:et för att ta bort ett projekt
        async function deleteProjectFromSheet(projectId) {
            if (!confirm("Är du säker på att du vill ta bort detta projekt permanent?")) {
                return;
            }

            try {
                 const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ 
                        action: 'delete', 
                        id: projectId 
                    }).toString()
                });
                
                if (!response.ok) throw new Error('API-anropet misslyckades.');
                
                // Ladda om data efter borttagning
                await loadProjects();
                
            } catch (error) {
                console.error("Fel vid borttagning av projekt:", error);
                alert(`Kunde inte ta bort. Kontrollera API-anslutningen. Fel: ${error.message}`);
            }
        }


        // =========================================================
        // 3. Formulärlogik
        // =========================================================
        
        function addProject() {
            const titel = document.getElementById('titel').value.trim();
            const status = document.getElementById('status').value.trim();
            const datum = document.getElementById('datum').value.trim();
            const deltagare = document.getElementById('deltagare').value.trim();
            const beskrivning = document.getElementById('beskrivning').value.trim();
            
            if (!titel || !status || !datum) {
                alert("Titel, Status och Datum måste fyllas i.");
                return;
            }

            const projectData = {
                titel,
                status,
                datum,
                deltagare,
                beskrivning
            };

            if (editingProjectId) {
                // Uppdatera
                projectData.id = editingProjectId;
                saveProjectToSheet(projectData, 'update');
                
                editingProjectId = null;
                document.querySelector('#addProjectForm button').textContent = 'Lägg till projekt';
            } else {
                // Lägg till nytt
                projectData.id = 'p' + Date.now(); // Skapa ett tillfälligt ID
                saveProjectToSheet(projectData, 'create');
            }

            document.getElementById('addProjectForm').reset();
        }

        function editProject(projectId) {
            const projectToEdit = projects.find(p => p.id === projectId);
            
            if (projectToEdit) {
                document.getElementById('titel').value = projectToEdit.titel;
                document.getElementById('status').value = projectToEdit.status;
                document.getElementById('datum').value = projectToEdit.datum;
                document.getElementById('deltagare').value = projectToEdit.deltagare;
                document.getElementById('beskrivning').value = projectToEdit.beskrivning;

                editingProjectId = projectId;
                document.querySelector('#addProjectForm button').textContent = 'Spara ändringar';
                document.getElementById('addProjectForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteProject(projectId) {
             deleteProjectFromSheet(projectId); // Anropar den nya API-funktionen
        }


        // =========================================================
        // 4. Filter och Visning
        // =========================================================

        // (Filter- och visningsfunktionerna är desamma som tidigare, men använder nu 'projects' arrayen som fyllts i av API:et)
        function populateYearFilter() {
            // ... (Koden för populateYearFilter som använder 'projects' arrayen) ...
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '<option value="">Alla år</option>'; 
            
            const currentYear = new Date().getFullYear();
            const futureLimit = currentYear + 10;
            const years = new Set();
            
            projects.forEach(project => {
                if (project.datum) {
                    const parts = project.datum.split('-').map(y => y.trim()).filter(y => y !== '');
                    
                    if (parts.length === 1) {
                        years.add(parseInt(parts[0]));
                    } else if (parts.length === 2) {
                        const start = parseInt(parts[0]);
                        const end = parseInt(parts[1]) || futureLimit; 
                        
                        if (!isNaN(start) && !isNaN(end)) {
                            const maxEnd = Math.min(end, futureLimit); 
                            for (let year = start; year <= maxEnd; year++) {
                                years.add(year);
                            }
                        }
                    } else {
                        const yearMatches = project.datum.match(/\b\d{4}\b/g);
                        if (yearMatches) {
                            yearMatches.forEach(y => years.add(parseInt(y)));
                        }
                    }
                }
            });

            const sortedYears = Array.from(years)
                .filter(y => !isNaN(y))
                .sort((a, b) => b - a); 
            
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
            const yearFilter = document.getElementById('yearFilter').value;
            const searchQuery = document.getElementById('searchQuery').value.toLowerCase().trim();

            let filteredProjects = projects.filter(project => {
                const statusMatch = !statusFilter || project.status.toLowerCase() === statusFilter;

                const yearMatch = !yearFilter || (
                    project.datum && project.datum.split('-').length >= 1 && (
                        (project.datum.includes(yearFilter)) || 
                        (
                            project.datum.split('-').length >= 2 && 
                            parseInt(yearFilter) >= parseInt(project.datum.split('-')[0].trim()) && 
                            (project.datum.split('-')[1].trim() === '' || parseInt(yearFilter) <= parseInt(project.datum.split('-')[1].trim()))
                        )
                    )
                );

                const searchMatch = !searchQuery || 
                    project.titel.toLowerCase().includes(searchQuery) ||
                    (project.beskrivning || '').toLowerCase().includes(searchQuery) ||
                    (project.deltagare || '').toLowerCase().includes(searchQuery);

                return statusMatch && yearMatch && searchMatch;
            });

            displayProjects(filteredProjects);
        }

        function displayProjects(projectsToDisplay) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (projectsToDisplay.length === 0) {
                resultsDiv.innerHTML = '<p>Inga projekt matchar dina filter och sökning. Lägg till ditt första projekt ovan!</p>';
                return;
            }

            projectsToDisplay.forEach(project => {
                const projectDiv = document.createElement('div');
                projectDiv.className = 'project-card';
                projectDiv.innerHTML = `
                    <h3>${project.titel}</h3>
                    <p><strong>Status:</strong> ${project.status}</p>
                    <p><strong>Datum:</strong>
